<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>DuckFlix VR v5</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
body{margin:0;background:black;color:white;font-family:Arial}
#tela2d{
  position:fixed; inset:0; z-index:10;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  background:radial-gradient(#111,#000);
}
button{
  padding:14px 26px; margin:10px;
  font-size:18px; border-radius:10px;
  border:none; background:#0066ff; color:white;
}
button:disabled{background:#333}
</style>
</head>

<body>

<!-- ===== TELA 2D ===== -->
<div id="tela2d">
  <h1>ðŸ¦† DuckFlix VR</h1>
  <p>Escolha sua pasta de filmes</p>
  <button id="pick">ðŸ“‚ Escolher Pasta</button>
  <button id="startVR" disabled>ðŸŽ¬ Entrar no Cinema</button>
</div>

<video id="video" playsinline crossorigin="anonymous"></video>

<a-scene>

<!-- CAMERA + GAZE -->
<a-entity position="0 1.6 0">
  <a-camera>
    <a-cursor fuse="true" fuse-timeout="1200"
      geometry="primitive:ring; radiusInner:0.015; radiusOuter:0.03"
      material="color:yellow; shader:flat; opacity:0.9">
    </a-cursor>
  </a-camera>
</a-entity>

<!-- LUZ CINEMA -->
<a-light type="ambient" intensity="0.3"></a-light>
<a-light type="spot" position="0 4 -3" angle="45" intensity="1"></a-light>

<!-- CHÃƒO TEXTURIZADO (FAKE POR CÃ“DIGO) -->
<a-plane rotation="-90 0 0" width="30" height="30"
 material="color:#222; roughness:0.9"></a-plane>

<!-- PAREDES -->
<a-plane position="0 3 -12" width="30" height="6" color="#111"></a-plane>
<a-plane position="-15 3 0" rotation="0 90 0" width="30" height="6" color="#111"></a-plane>
<a-plane position="15 3 0" rotation="0 -90 0" width="30" height="6" color="#111"></a-plane>
<a-plane position="0 6 0" rotation="90 0 0" width="30" height="30" color="#080808"></a-plane>

<!-- CADEIRAS (GERADAS POR CÃ“DIGO) -->
<a-entity id="cadeiras"></a-entity>

<!-- TELA -->
<a-video id="screen"
 src="#video"
 position="0 2.8 -11.8"
 width="10"
 height="5.6"
 material="shader:flat">
</a-video>

<!-- CONTROLES -->
<a-box id="pause" position="-1.5 1 -6" width="0.7" height="0.4" depth="0.2" color="#0066ff"></a-box>
<a-text value="â¯" position="-1.5 1 -5.8" align="center"></a-text>

<a-box id="close" position="1.5 1 -6" width="0.7" height="0.4" depth="0.2" color="#aa0000"></a-box>
<a-text value="âŒ" position="1.5 1 -5.8" align="center"></a-text>

<!-- LISTA -->
<a-entity id="lista" position="8 4 -6"></a-entity>

</a-scene>

<script>
let root=null, offset=0, currentFile="";
const video=document.getElementById("video");
const lista=document.getElementById("lista");

/* TELA 2D */
pick.onclick=async()=>{
  root=await window.showDirectoryPicker();
  startVR.disabled=false;
};

startVR.onclick=()=>{
  tela2d.style.display="none";
  document.querySelector("a-scene").enterVR();
  criarCadeiras();
  carregar();
};

/* CADEIRAS */
function criarCadeiras(){
  const c=document.getElementById("cadeiras");
  for(let z=0;z<4;z++){
    for(let x=-3;x<=3;x++){
      const seat=document.createElement("a-box");
      seat.setAttribute("position",`${x*1.2} 0.5 ${-4-z*1.5}`);
      seat.setAttribute("width","0.9");
      seat.setAttribute("height","0.9");
      seat.setAttribute("depth","0.9");
      seat.setAttribute("color","#111");
      c.appendChild(seat);
    }
  }
}

/* CARREGAR FILMES */
async function carregar(){
  lista.innerHTML=""; offset=0;
  for await (const d of root.values()){
    if(d.kind==="directory" && d.name==="Filmes"){
      for await (const f of d.values()){
        if(f.kind==="file" && f.name.match(/\.(mp4|webm)$/)){
          const url=URL.createObjectURL(await f.getFile());
          criarItem(f.name,url);
        }
      }
    }
  }
}

/* ITEM COM GAZE */
function criarItem(nome,url){
  const b=document.createElement("a-plane");
  b.setAttribute("width","3");
  b.setAttribute("height","0.45");
  b.setAttribute("color","#222");
  b.setAttribute("position",`0 ${-offset} 0`);

  let tmr=null;

  b.addEventListener("mouseenter",()=>{
    b.setAttribute("color","#555");
    tmr=setTimeout(()=>{
      abrirFilme(nome,url);
    },1200);
  });

  b.addEventListener("mouseleave",()=>{
    b.setAttribute("color","#222");
    clearTimeout(tmr);
  });

  const t=document.createElement("a-text");
  t.setAttribute("value",nome);
  t.setAttribute("width","3");
  t.setAttribute("align","left");
  t.setAttribute("position","-1.45 0 0.01");

  b.appendChild(t);
  lista.appendChild(b);
  offset+=0.5;
}

/* ABRIR FILME */
function abrirFilme(nome,url){
  currentFile=nome;
  video.src=url;
  video.currentTime=parseFloat(localStorage.getItem(nome))||0;
  video.play();
}

/* SALVAR POSIÃ‡ÃƒO */
video.ontimeupdate=()=>{
  if(currentFile){
    localStorage.setItem(currentFile,video.currentTime);
  }
};

/* CONTROLES */
pause.addEventListener("mouseenter",()=>{
  setTimeout(()=>{
    video.paused?video.play():video.pause();
  },1200);
});

close.addEventListener("mouseenter",()=>{
  setTimeout(()=>{
    video.pause();
    video.src="";
    currentFile="";
  },1200);
});
</script>

</body>
</html>
