<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>DuckFlix VR v5.5</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
body{margin:0;background:black;color:white;font-family:Arial}
#tela2d{
  position:fixed; inset:0; z-index:10;
  display:flex; flex-direction:column;
  justify-content:center; align-items:center;
  background:radial-gradient(#111,#000);
}
button{
  padding:14px 26px; margin:10px;
  font-size:18px; border-radius:10px;
  border:none; background:#0066ff; color:white;
}
button:disabled{background:#333}
</style>
</head>

<body>

<!-- ===== TELA 2D ===== -->
<div id="tela2d">
  <h1>ðŸ¦† DuckFlix VR</h1>
  <p>Escolha sua pasta de filmes</p>
  <button id="pick">ðŸ“‚ Escolher Pasta</button>
  <button id="startVR" disabled>ðŸŽ¬ Entrar no Cinema</button>
</div>

<video id="video" playsinline crossorigin="anonymous"></video>

<a-scene>

<!-- CAMERA -->
<a-entity id="rig" position="0 0 0">
  <a-entity id="camera" position="0 1.6 0">
    <a-camera>
      <a-cursor fuse="true" fuse-timeout="1200"
        geometry="primitive:ring; radiusInner:0.014; radiusOuter:0.03"
        material="color:yellow; shader:flat; opacity:0.9">
      </a-cursor>
    </a-camera>
  </a-entity>
</a-entity>

<!-- LUZ -->
<a-light type="ambient" intensity="0.35"></a-light>
<a-light type="spot" position="0 4 -4" angle="45" intensity="1.2"></a-light>

<!-- CHÃƒO TEXTURIZADO (PADRÃƒO CINEMA) -->
<a-plane rotation="-90 0 0" width="30" height="30"
 material="shader:flat; color:#222"></a-plane>

<!-- PAREDES -->
<a-plane position="0 3 -12" width="30" height="6" color="#111"></a-plane>
<a-plane position="-15 3 0" rotation="0 90 0" width="30" height="6" color="#0e0e0e"></a-plane>
<a-plane position="15 3 0" rotation="0 -90 0" width="30" height="6" color="#0e0e0e"></a-plane>
<a-plane position="0 6 0" rotation="90 0 0" width="30" height="30" color="#080808"></a-plane>

<!-- CADEIRAS -->
<a-entity id="cadeiras"></a-entity>

<!-- TELA -->
<a-video id="screen"
 src="#video"
 position="0 2.9 -11.8"
 width="10"
 height="5.6"
 material="shader:flat">
</a-video>

<!-- CONTROLES AO LADO DA TELA -->
<a-entity position="6 2.5 -10">

  <!-- PLAY -->
  <a-entity id="playBtn">
    <a-circle radius="0.35" color="#222"></a-circle>
    <a-triangle color="#00ff66"
      vertex-a="0 0.18 0"
      vertex-b="-0.14 -0.12 0"
      vertex-c="0.14 -0.12 0">
    </a-triangle>
  </a-entity>

  <!-- PAUSE -->
  <a-entity id="pauseBtn" position="0 -1 0">
    <a-circle radius="0.35" color="#222"></a-circle>
    <a-box width="0.08" height="0.3" depth="0.02" position="-0.06 0 0" color="#ffaa00"></a-box>
    <a-box width="0.08" height="0.3" depth="0.02" position="0.06 0 0" color="#ffaa00"></a-box>
  </a-entity>

  <!-- CLOSE -->
  <a-entity id="closeBtn" position="0 -2 0">
    <a-circle radius="0.35" color="#330000"></a-circle>
    <a-text value="âœ–" align="center" position="0 -0.12 0.01" color="#ff4444"></a-text>
  </a-entity>

</a-entity>

<!-- RECENTER -->
<a-entity id="recenterBtn" position="0 1 -4">
  <a-ring radius-inner="0.15" radius-outer="0.25" color="#00aaff"></a-ring>
  <a-text value="RECENTER" align="center" position="0 -0.45 0" width="3"></a-text>
</a-entity>

<!-- LISTA -->
<a-entity id="lista" position="8 4 -6"></a-entity>

</a-scene>

<script>
let root=null, offset=0, current="";
const video=document.getElementById("video");
const lista=document.getElementById("lista");

/* TELA 2D */
pick.onclick=async()=>{
  root=await window.showDirectoryPicker();
  startVR.disabled=false;
};

startVR.onclick=()=>{
  tela2d.style.display="none";
  document.querySelector("a-scene").enterVR();
  criarCadeiras();
  carregar();
};

/* CADEIRAS */
function criarCadeiras(){
  const c=document.getElementById("cadeiras");
  for(let z=0;z<5;z++){
    for(let x=-4;x<=4;x++){
      const seat=document.createElement("a-box");
      seat.setAttribute("position",`${x*1.2} 0.45 ${-4-z*1.5}`);
      seat.setAttribute("width","0.9");
      seat.setAttribute("height","0.9");
      seat.setAttribute("depth","0.9");
      seat.setAttribute("color","#111");
      c.appendChild(seat);
    }
  }
}

/* FILMES */
async function carregar(){
  lista.innerHTML=""; offset=0;
  for await(const d of root.values()){
    if(d.kind==="directory" && d.name==="Filmes"){
      for await(const f of d.values()){
        if(f.kind==="file" && f.name.match(/\.(mp4|webm)$/)){
          const url=URL.createObjectURL(await f.getFile());
          criarItem(f.name,url);
        }
      }
    }
  }
}

function criarItem(nome,url){
  const b=document.createElement("a-plane");
  b.setAttribute("width","3");
  b.setAttribute("height","0.45");
  b.setAttribute("color","#222");
  b.setAttribute("position",`0 ${-offset} 0`);

  let t=null;
  b.addEventListener("mouseenter",()=>{
    b.setAttribute("color","#555");
    t=setTimeout(()=>abrir(nome,url),1200);
  });
  b.addEventListener("mouseleave",()=>{
    b.setAttribute("color","#222");
    clearTimeout(t);
  });

  const txt=document.createElement("a-text");
  txt.setAttribute("value",nome);
  txt.setAttribute("width","3");
  txt.setAttribute("align","left");
  txt.setAttribute("position","-1.45 0 0.01");

  b.appendChild(txt);
  lista.appendChild(b);
  offset+=0.5;
}

function abrir(nome,url){
  current=nome;
  video.src=url;
  video.currentTime=parseFloat(localStorage.getItem(nome))||0;
  video.play();
}

video.ontimeupdate=()=>{
  if(current) localStorage.setItem(current,video.currentTime);
};

/* BOTÃ•ES */
playBtn.addEventListener("mouseenter",()=>setTimeout(()=>video.play(),1200));
pauseBtn.addEventListener("mouseenter",()=>setTimeout(()=>video.pause(),1200));
closeBtn.addEventListener("mouseenter",()=>setTimeout(()=>{
  video.pause(); video.src=""; current="";
},1200));

/* RECENTER */
recenterBtn.addEventListener("mouseenter",()=>{
  setTimeout(()=>{
    document.getElementById("rig").setAttribute("rotation","0 0 0");
  },1200);
});
</script>

</body>
</html>
