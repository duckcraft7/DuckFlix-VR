<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>DuckFlix VR Cinema</title>
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

<style>
body {
  margin: 0;
  background: black;
  color: white;
  font-family: Arial;
}

/* ===== TELA 2D ===== */
#start2d {
  position: fixed;
  inset: 0;
  background: radial-gradient(#111, #000);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10;
}

button {
  padding: 15px 30px;
  margin: 10px;
  font-size: 18px;
  border-radius: 10px;
  border: none;
  background: #0077ff;
  color: white;
}
button:disabled {
  background: #333;
}
</style>
</head>

<body>

<!-- ===== TELA 2D ===== -->
<div id="start2d">
  <h1>ü¶Ü DuckFlix VR</h1>
  <p>Escolha sua pasta de filmes</p>
  <button id="pickFolder">üìÇ Escolher Pasta</button>
  <button id="enterVR" disabled>üï∂Ô∏è Entrar no Cinema VR</button>
</div>

<!-- VIDEO -->
<video id="video" crossorigin="anonymous" playsinline></video>

<!-- ===== CENA VR ===== -->
<a-scene vr-mode-ui="enabled: true">

  <!-- CAMERA + OLHAR -->
  <a-entity position="0 1.6 0">
    <a-camera>
      <a-cursor
        fuse="true"
        fuse-timeout="1200"
        material="color: yellow; shader: flat">
      </a-cursor>
    </a-camera>
  </a-entity>

  <!-- LUZ -->
  <a-light type="ambient" intensity="0.6"></a-light>
  <a-light type="point" intensity="1" position="0 3 -2"></a-light>

  <!-- CINEMA REAL -->
  <a-plane rotation="-90 0 0" width="14" height="14" color="#222"></a-plane>
  <a-plane position="0 4 0" rotation="90 0 0" width="14" height="14" color="#111"></a-plane>
  <a-plane position="0 2 -7" width="14" height="4" color="#111"></a-plane>
  <a-plane position="-7 2 0" rotation="0 90 0" width="14" height="4" color="#111"></a-plane>
  <a-plane position="7 2 0" rotation="0 -90 0" width="14" height="4" color="#111"></a-plane>

  <!-- TELA -->
  <a-video id="screen"
    src="#video"
    position="0 2 -6.9"
    width="7"
    height="3.9"
    material="shader: flat">
  </a-video>

  <!-- LISTA LATERAL -->
  <a-entity id="lista" position="4.5 2.5 -4"></a-entity>

</a-scene>

<script>
let rootDir = null;
const pickBtn = document.getElementById("pickFolder");
const enterBtn = document.getElementById("enterVR");
const start2d = document.getElementById("start2d");

const video = document.getElementById("video");
const screen = document.getElementById("screen");
const lista = document.getElementById("lista");

let yOffset = 0;

// ===== ESCOLHER PASTA (2D) =====
pickBtn.onclick = async () => {
  if (!window.showDirectoryPicker) {
    alert("Seu navegador n√£o suporta acesso a pastas.");
    return;
  }

  rootDir = await window.showDirectoryPicker();
  enterBtn.disabled = false;
  alert("Pasta carregada!");
};

// ===== ENTRAR NO VR =====
enterBtn.onclick = async () => {
  start2d.style.display = "none";

  const scene = document.querySelector("a-scene");
  if (scene.enterVR) scene.enterVR();

  await carregarBiblioteca();
};

// ===== CARREGAR FILMES E YOUTUBE =====
async function carregarBiblioteca() {
  lista.innerHTML = "";
  yOffset = 0;

  for await (const entry of rootDir.values()) {
    if (entry.kind === "directory") {
      if (entry.name === "Filmes") carregarFilmes(entry);
      if (entry.name === "YouTube Links") carregarYT(entry);
    }
  }
}

// ----- FILMES LOCAIS -----
async function carregarFilmes(dir) {
  for await (const file of dir.values()) {
    if (file.kind === "file") {
      const blob = await file.getFile();
      const url = URL.createObjectURL(blob);
      criarItem("üé¨ " + file.name, () => tocarVideo(url));
    }
  }
}

function tocarVideo(url) {
  video.src = url;
  video.play();
}

// ----- YOUTUBE TXT -----
async function carregarYT(dir) {
  for await (const file of dir.values()) {
    if (file.kind === "file" && file.name.endsWith(".txt")) {
      const f = await file.getFile();
      const linhas = (await f.text()).split("\n");

      for (let linha of linhas) {
        let [nome, link] = linha.split("|");
        if (link) {
          criarItem("‚ñ∂ " + nome, () => abrirYT(link.trim()));
        }
      }
    }
  }
}

function abrirYT(link) {
  const embed = link.replace("watch?v=", "embed/");
  screen.setAttribute("src", embed);
}

// ===== ITEM DA LISTA (OLHAR) =====
function criarItem(texto, acao) {
  const btn = document.createElement("a-plane");
  btn.setAttribute("width", "3");
  btn.setAttribute("height", "0.4");
  btn.setAttribute("color", "#333");
  btn.setAttribute("position", `0 ${-yOffset} 0`);

  btn.addEventListener("click", acao);

  const txt = document.createElement("a-text");
  txt.setAttribute("value", texto);
  txt.setAttribute("align", "left");
  txt.setAttribute("color", "white");
  txt.setAttribute("width", "3");
  txt.setAttribute("position", "-1.45 0 0.01");

  btn.appendChild(txt);
  lista.appendChild(btn);
  yOffset += 0.45;
}
</script>

</body>
</html>
